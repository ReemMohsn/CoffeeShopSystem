@* ~/Views/Favorit/Index.cshtml *@
@model IEnumerable<happinesCafe.Models.FavoriteViewModel>
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    ViewData["Title"] = "Favorites";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var requestToken = Antiforgery.GetAndStoreTokens(Context).RequestToken;
}

@section Links{
    <link rel="stylesheet" href="~/css/css.css" asp-append-version="true"/>
    <title>Favorites</title>
    <style>
        /* --- Styles remain the same as previous version --- */
        .faivoret { padding-bottom: 50px; }
        .faivoret .title { text-align: center; margin-top: 6%; margin-bottom: 40px; }
        .title img { width: 45px; vertical-align: middle; margin-right: 10px; }
        .title span { font-size: 4rem; color: #F2F1F4; vertical-align: middle; }
        .faivoret .Products { margin: 50px auto 20px auto; padding: 0 20px; max-width: 1200px; display: flex; flex-wrap: wrap; justify-content: center; gap: 40px 30px; min-height: 200px; }
        .faivoret .Products .Product { width: 250px; min-height: 330px; border: solid 4px #713a20; border-radius: 20px; box-shadow: 0px 0px 4px 2px #713a20; display: flex; flex-direction: column; background-color: #3a1e10; overflow: hidden; position: relative; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .faivoret .Products .Product:hover { transform: translateY(-5px); box-shadow: 0px 4px 8px 3px #713a20; }
        .Product .img-heart { width: 30px; height: auto; position: absolute; top: 10px; right: 10px; cursor: pointer; z-index: 2; transition: transform 0.2s ease, opacity 0.2s ease; }
        .Product .img-heart:hover { transform: scale(1.15); }
        .Product .img-heart.processing { opacity: 0.5; pointer-events: none; }
        .Product .product-link { display: block; text-align: center; margin-top: 35px; padding: 10px; }
        .Product img.img-pro, .Product img.img-pro-coffee { max-width: 100%; height: 120px; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(177, 110, 37, 0.7)); margin-bottom: 15px; display: inline-block; }
        .Product img.img-pro { width: 120px; }
        .Product img.img-pro-coffee { width: 90px; }
        .faivoret .Products .Product .Productnam { padding: 15px; font-size: 1.5rem; color: #F2F1F4; text-align: center; flex-grow: 1; display: flex; align-items: center; justify-content: center; min-height: 60px; line-height: 1.3; }
        .faivoret .Products .Product .Productnam a { color: inherit; text-decoration: none; transition: color 0.2s ease; }
        .faivoret .Products .Product .Productnam a:hover { color: #e0a867; }
        .Product .product-footer { padding: 12px 15px; background-color: #713a20; text-align: center; margin-top: auto; }
        .Product .product-footer .view-details-link { color: #F2F1F4; text-decoration: none; font-weight: bold; font-size: 1rem; transition: color 0.2s ease; }
        .Product .product-footer .view-details-link:hover { color: #e0a867; }
        .no-favorites-message { text-align: center; color: #ccc; font-size: 1.2rem; padding: 50px 20px; width: 100%; }
        .no-favorites-message a { color: #b16e25; text-decoration: underline; }
        .no-favorites-message a:hover { color: #e0a867; }
        .alert.alert-danger { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; padding: 15px; margin: 20px auto; border: 1px solid transparent; border-radius: 4px; max-width: 600px; text-align: center; }
        .alert.alert-danger a { color: #721c24; font-weight: bold; text-decoration: underline; }
        .favorite-item.removing { transition: opacity 0.5s ease-out, transform 0.5s ease-out, height 0.5s ease-out, margin 0.5s ease-out, padding 0.5s ease-out; opacity: 0; transform: scale(0.8); height: 0; margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; border-width: 0; overflow: hidden; }
    </style>
}

@* Hidden input for AntiForgery Token (Value read by JS) *@
<input type="hidden" id="RequestVerificationToken" name="__RequestVerificationToken" value="@requestToken" />

<section class="faivoret" id="faivoret">
    <div class="title">
        <img src="~/imges/galeb.png" alt="Favorite Icon"><span>Favorite</span>
    </div>

    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @ViewBag.ErrorMessage
            <a asp-controller="SignInUp" asp-action="SignIn">Login Here</a>
        </div>
    }

    <div class="Products">
        @if (Model != null && Model.Any())
        {
            @foreach (var item in Model)
            {
                var productAction = "ProductDetails";
                if (item.CategoryId == 1 || item.CategoryId == 2) { productAction = "ProductDetailsDrinks"; }
                else if (item.CategoryId == 3) { productAction = "ProductDetailsSweets"; }

                <div class="Product favorite-item" data-product-id="@item.ProductId">
                    <img class="img-heart remove-favorite-btn" src="~/imges/galeb.png" alt="Remove from Favorites" title="Remove from Favorites">

                    <a asp-controller="Products" asp-action="@productAction" asp-route-id="@item.ProductId" class="product-link">
                        <img class="~/imges/@item.ProductPictureClass" src="@Url.Content(item.ProductPictureUrl ?? "~/imges/placeholder.png")" alt="@item.ProductName">
                    </a>

                    <div class="Productnam">
                         <a asp-controller="Products" asp-action="@productAction" asp-route-id="@item.ProductId">
                            @item.ProductName
                         </a>
                    </div>

                    <div class="product-footer">
                        <a asp-controller="Products" asp-action="@productAction" asp-route-id="@item.ProductId" class="view-details-link">
                            View Details
                        </a>
                    </div>
                </div>
            }
        }
        else if (string.IsNullOrEmpty(ViewBag.ErrorMessage))
        {
            <div class="no-favorites-message">
                 You haven't added any favorites yet! <br/>
                 <a asp-controller="Home" asp-action="Index">Browse our products</a> to find some.
            </div>
        }
    </div>
</section>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const productsContainer = document.querySelector('.Products');
            const verificationTokenInput = document.getElementById('RequestVerificationToken');
            const verificationToken = verificationTokenInput?.value; // Get token value

            if (!productsContainer) {
                console.warn('Favorites .Products container not found.');
                return;
            }
            if (!verificationToken) {
                console.error('AntiForgery Token input field not found or has no value. Removal disabled.');
                productsContainer.querySelectorAll('.remove-favorite-btn').forEach(btn => btn.style.display = 'none');
                return;
            }

            productsContainer.addEventListener('click', function (event) {
                const removeButton = event.target;

                if (removeButton.classList.contains('remove-favorite-btn')) {
                    const productCard = removeButton.closest('.favorite-item');
                    if (!productCard) return;

                    const productId = productCard.dataset.productId;
                    if (!productId) return;

                    console.log(`Attempting to remove favorite: ${productId}`);
                    removeButton.classList.add('processing');

                    // *** MODIFIED FETCH CALL ***
                    fetch('/Favorit/ToggleFavorite', {
                        method: 'POST',
                        headers: {
                            // Send token in the header (standard practice for AJAX with AntiForgery)
                            'RequestVerificationToken': verificationToken,
                            // Set Content-Type to JSON
                            'Content-Type': 'application/json',
                            'Accept': 'application/json' // Indicate we expect JSON back
                        },
                        // Send productId in the body as a JSON string
                        body: JSON.stringify({ productId: parseInt(productId) }) // Ensure productId is a number
                    })
                    .then(response => {
                        if (!response.ok) {
                            // Try to get error message from response body
                            return response.json()
                                .catch(() => ({ message: `Server responded with status: ${response.status}` })) // Fallback if JSON parsing fails
                                .then(errData => { throw new Error(errData.message || `HTTP error ${response.status}`) });
                        }
                        return response.json(); // Parse success response
                    })
                    .then(data => {
                        console.log('ToggleFavorite response (for removal):', data);
                        if (data.success && !data.isFavorite) { // Check if successfully removed
                            productCard.classList.add('removing');
                            productCard.addEventListener('transitionend', () => {
                                productCard.remove();
                                // Check if container is empty and add message if needed
                                if (!productsContainer.querySelector('.favorite-item') && !productsContainer.querySelector('.no-favorites-message')) {
                                    const infoDiv = document.createElement('div');
                                    infoDiv.className = 'no-favorites-message';
                                    infoDiv.innerHTML = "You haven't added any favorites yet! <br/> <a href='/Home/Index'>Browse our products</a> to find some.";
                                    productsContainer.appendChild(infoDiv);
                                }
                            }, { once: true });
                            // showToast(data.message || 'Removed from favorites!'); // Optional notification
                        } else {
                            // Removal failed or resulted in item being added (unexpected)
                            alert(data.message || 'Could not remove item.');
                            removeButton.classList.remove('processing'); // Make button clickable again
                            if (data.redirectToLogin) {
                                window.location.href = '/SignInUp/SignIn';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error removing favorite:', error);
                        alert('An error occurred: ' + error.message);
                        removeButton.classList.remove('processing'); // Make button clickable again
                    });
                }
            });
        });
    </script>
}
